# docker-compose.yml

version: '3.8'
services:
  # 1. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ (app)
  app1:
    build: .                 # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ Dockerfileì„ ì‚¬ìš©í•´ ì´ë¯¸ì§€ ë¹Œë“œ
    container_name: my-spring-app-1
    ports:
      - "8081:8080"          # Windows í˜¸ìŠ¤íŠ¸ í¬íŠ¸ -> ì»¨í…Œì´ë„ˆ í¬íŠ¸ ì—°ê²°
    depends_on:
      db:
        condition: service_healthy # DBê°€ ë¨¼ì € ì‹œì‘ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
      mosquitto: #ë¸Œë¡œì»¤ê°€ ëœ¬ í›„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
        condition: service_healthy
    environment:
      # ğŸš¨ application.ymlì˜ ${} ë³€ìˆ˜ì— ì£¼ì…í•  ì‹¤ì œ ê°’
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/university?useUnicode=true&characterEncoding=utf8  # 'db'ëŠ” MySQL ì„œë¹„ìŠ¤ ì´ë¦„
      SPRING_DATASOURCE_USERNAME: ${MY_SQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      # MQTT ì„¤ì • : ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ ì´ë¯€ë¡œ ì„œë¹„ìŠ¤ ì´ë¦„(mosquitto)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
      MQTT_BROKER_URL: tcp://mosquitto:1883
  # ê°™ì€ ì„œë¹„ìŠ¤ ë‘ë²ˆì§¸
  app2:
    build: .
    container_name: my-spring-app-2
    ports:
      - "8082:8080" # 8082ë¡œ ë“¤ì–´ì˜¤ë©´ ì»¨í…Œì´ë„ˆì˜ 8080ìœ¼ë¡œ
    depends_on:
      db:
        condition: service_healthy
      mosquitto: #ë¸Œë¡œì»¤ê°€ ëœ¬ í›„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/university?useUnicode=true&characterEncoding=utf8
      SPRING_DATASOURCE_USERNAME: ${MY_SQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      # MQTT ì„¤ì • : ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ ì´ë¯€ë¡œ ì„œë¹„ìŠ¤ ì´ë¦„(mosquitto)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
      MQTT_BROKER_URL: tcp://mosquitto:1883
  # ê°™ì€ ì„œë¹„ìŠ¤ ì„¸ë²ˆì§¸
  app3:
    build: .
    container_name: my-spring-app-3
    ports:
      - "8083:8080" # 8083ë¡œ ë“¤ì–´ì˜¤ë©´ ì»¨í…Œì´ë„ˆì˜ 8080ìœ¼ë¡œ
    depends_on:
      db:
        condition: service_healthy
      mosquitto: #ë¸Œë¡œì»¤ê°€ ëœ¬ í›„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/university?useUnicode=true&characterEncoding=utf8
      SPRING_DATASOURCE_USERNAME: ${MY_SQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      # MQTT ì„¤ì • : ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ ì´ë¯€ë¡œ ì„œë¹„ìŠ¤ ì´ë¦„(mosquitto)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
      MQTT_BROKER_URL: tcp://mosquitto:1883

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto_broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ (db)
  db:
    image: mysql:8.0         # MySQL 8.0 ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš©
    container_name: mysql-db
    ports:
      - "3307:3306"          # ë¡œì»¬ DB íˆ´ ì ‘ì†ìš© í¬íŠ¸ (ì„ íƒ ì‚¬í•­)
    environment:
      MYSQL_DATABASE: university
      #MYSQL_USER: root
      #MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    # ì»¨í…Œì´ë„ˆ ì‚­ì œ ì‹œì—ë„ ë°ì´í„° ìœ ì‹¤ ë°©ì§€ë¥¼ ìœ„í•œ ë³¼ë¥¨ ì„¤ì •
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$MYSQL_ROOT_PASSWORD" ]
      timeout: 10s
      retries: 10
      start_period: 20s # MySQL ì´ˆê¸°í™”ì— í•„ìš”í•œ ì¶©ë¶„í•œ ì‹œê°„ (20ì´ˆ)
  redis:
    image: redis:alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    # 1. ë°ì´í„°ë¥¼ ì €ì¥í•  ê³µê°„ ì—°ê²° (ë³¼ë¥¨ ì„¤ì •)
    volumes:
      - ./redis_data:/data
    # 2. ë°ì´í„° ë³´ì¡´ ë°©ì‹ ë³€ê²½ (AOF ëª¨ë“œ í™œì„±í™”)
    command: redis-server --appendonly yes --dir /data
    networks:
      - default
  nginx:
    image: nginx:latest
    container_name: nginx-proxy
    ports:
      - "80:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ../images:/usr/share/nginx/html/images
    depends_on:
      - app1
      - app2
      - app3
  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: redis-insight
    ports:
      - "5540:5540"
volumes:
  mysql_data: